{"version":3,"sources":["repository/ImageRepository.es6"],"names":["ImageRepository","db","PouchDB","allDocs","include_docs","attachments","then","data","Promise","all","rows","map","row","getAttachment","id","Object","keys","doc","_attachments","comments","image_likes","imageUrl","URL","createObjectURL","catch","err","console","log","image","put","get","_id","attachment","like","filter","_like","own","userId","comment","idImage","commentId","remove"],"mappings":"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","file":"ImageRepository.js","sourcesContent":["/**\r\n * Created by Паша on 10.03.2017.\r\n */\r\nexport class ImageRepository {\r\n    constructor() {\r\n        this.db = new PouchDB('imagesnew');\r\n    }\r\n\r\n    getAll() {\r\n        return this.db.allDocs({\r\n            include_docs: true,\r\n            attachments: false\r\n        }).then((data)=> {\r\n            return Promise.all((data.rows.map((row)=> {\r\n                return this.db.getAttachment(row.id, Object.keys(row.doc._attachments)[0]).then((data)=> {\r\n                    return {\r\n                        id: row.id,\r\n                        comments: row.doc.comments,\r\n                        image_likes: row.doc.image_likes,\r\n                        imageUrl: URL.createObjectURL(data)\r\n                    }\r\n                });\r\n            }))).catch((err)=> {\r\n                console.log(err);\r\n            });\r\n        });\r\n    }\r\n\r\n    put(image) {\r\n        return this.db.put(image).then((data)=> {\r\n            return this.db.get(data.id)\r\n        }).then((doc) => {\r\n            return this.db.getAttachment(doc._id, Object.keys(doc._attachments)[0])\r\n                .then(attachment => {\r\n                    return {\r\n                        id: doc._id,\r\n                        comments: doc.comments,\r\n                        image_likes: doc.image_likes,\r\n                        imageUrl: URL.createObjectURL(attachment)\r\n                    };\r\n                });\r\n        });\r\n    }\r\n\r\n    addLike(_id, like) {\r\n        return this.db.get(_id).then((doc) => {\r\n            let image = {...doc, image_likes: [...doc.image_likes.filter(_like => _like.own !== like.own), like]};\r\n            return this.db.put(image).then(res => image);\r\n        });\r\n    }\r\n\r\n    deleteLike(_id, userId) {\r\n        return this.db.get(_id).then((doc) => {\r\n            console.log(doc, \"doc\");\r\n            let image = {...doc, image_likes: doc.image_likes.filter(like => like.own !== userId)};\r\n            console.log(image, \"image\");\r\n            return this.db.put(image).then(res => image);\r\n\r\n        });\r\n    }\r\n\r\n    addComment(_id, comment) {\r\n        return this.db.get(_id).then((doc) => {\r\n            let image = {...doc, comments: [...doc.comments, comment]};\r\n            return this.db.put(image);\r\n        });\r\n    }\r\n\r\n    deleteComment(idImage, commentId) {\r\n        return this.db.get(idImage).then((doc) => {\r\n            let image = {...doc, comments: doc.comments.filter(comment => comment.id !== commentId)};\r\n            return this.db.put(image);\r\n        });\r\n    }\r\n\r\n    deleteImageById(_id) {\r\n        return this.db.get(_id).then((doc) => {\r\n            return this.db.remove(doc);\r\n        })\r\n    }\r\n}\r\n"]}